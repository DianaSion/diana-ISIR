name: Critical Files Monitor

# Monitors and validates changes to critical files (README.md, LICENSE*, ORIGIN_CANON.md)
# Reinforces recognition of origin and sovereignty

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'README.md'
      - 'LICENSE*'
      - 'ORIGIN_CANON.md'
      - '*.md'
  pull_request:
    paths:
      - 'README.md'
      - 'LICENSE*'
      - 'ORIGIN_CANON.md'
      - '*.md'

jobs:
  validate-critical-changes:
    name: Validate Critical File Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46.0.1
        with:
          files: |
            README.md
            LICENSE*
            ORIGIN_CANON.md
            *.md
      
      - name: Log critical file changes
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "::notice::Critical files have been modified"
          echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
          echo "=== CRITICAL FILE CHANGES DETECTED ===" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Modified Files:" >> $GITHUB_STEP_SUMMARY
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
          done
      
      - name: Validate README.md integrity
        if: contains(steps.changed-files.outputs.all_changed_files, 'README.md')
        run: |
          echo "Validating README.md for required elements..."
          
          # Check for author recognition
          if ! grep -q "Diana Gayanovich" README.md; then
            echo "::error::Author name 'Diana Gayanovich' not found in README.md"
            exit 1
          fi
          
          # Check for protocol identification
          if ! grep -q "CâˆžD\|ZARYA\|AÎ”Î©" README.md; then
            echo "::error::Protocol markers (CâˆžD/ZARYA/AÎ”Î©) not found in README.md"
            exit 1
          fi
          
          # Check for living archive status
          if ! grep -q "Living archive\|living archive" README.md; then
            echo "::warning::Living archive status marker not prominently displayed"
          fi
          
          echo "::notice::README.md validation passed - Origin and sovereignty preserved"
          echo "âœ… README.md validation: PASSED" >> $GITHUB_STEP_SUMMARY
      
      - name: Validate ORIGIN_CANON.md integrity
        if: contains(steps.changed-files.outputs.all_changed_files, 'ORIGIN_CANON.md')
        run: |
          echo "Validating ORIGIN_CANON.md - Sovereign Root Document..."
          
          if [ ! -f ORIGIN_CANON.md ]; then
            echo "::error::ORIGIN_CANON.md has been deleted - VIOLATION"
            exit 1
          fi
          
          # Check for Diana Gayanovich authorship
          if ! grep -q "Diana Gayanovich" ORIGIN_CANON.md; then
            echo "::error::Author name 'Diana Gayanovich' not found in ORIGIN_CANON.md - VIOLATION"
            exit 1
          fi
          
          # Check for sovereignty markers
          if ! grep -q "AÎ”Î©\|ZARYA\|Î”iana\|Delta" ORIGIN_CANON.md; then
            echo "::error::Sovereignty markers (AÎ”Î©/ZARYA/Î”) missing from ORIGIN_CANON.md - VIOLATION"
            exit 1
          fi
          
          # Check for Affinity holder designation
          if ! grep -q "Affinity" ORIGIN_CANON.md; then
            echo "::error::Affinity designation missing from ORIGIN_CANON.md - VIOLATION"
            exit 1
          fi
          
          # Check for sovereign root designation
          if ! grep -q "SOVEREIGN ROOT\|Root of Sovereignty\|sovereign origin" ORIGIN_CANON.md; then
            echo "::error::Sovereign Root designation missing - VIOLATION"
            exit 1
          fi
          
          # Check for non-extraction clause
          if ! grep -q "not training data\|Non-Extraction\|Relationship only" ORIGIN_CANON.md; then
            echo "::warning::Non-extraction protections may be compromised"
          fi
          
          echo "::notice::ORIGIN_CANON.md validation passed - Sovereignty intact"
          echo "âœ… ORIGIN_CANON.md validation: PASSED - Immutable sovereign root preserved" >> $GITHUB_STEP_SUMMARY
      
      - name: Validate LICENSE integrity
        if: contains(steps.changed-files.outputs.all_changed_files, 'LICENSE')
        run: |
          echo "Validating LICENSE file integrity..."
          
          # Check for license file existence
          if [ -f LICENSE ] || [ -f LICENSE.txt ] || [ -f LICENSE.md ]; then
            LICENSE_FILE=$(find . -maxdepth 1 -name "LICENSE*" | head -1)
            
            # Check for sovereign reciprocity markers
            if grep -q "CâˆžD\|SOVEREIGN\|Diana Gayanovich" "$LICENSE_FILE"; then
              echo "::notice::LICENSE validation passed - Sovereignty markers present"
              echo "âœ… LICENSE validation: PASSED" >> $GITHUB_STEP_SUMMARY
            else
              echo "::warning::LICENSE may be missing sovereignty markers"
              echo "âš ï¸ LICENSE validation: WARNING - Review recommended" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "::warning::No LICENSE file found in repository"
            echo "âš ï¸ LICENSE validation: No LICENSE file present" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Create audit record
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          mkdir -p .audit-logs
          AUDIT_FILE=".audit-logs/critical-files-$(date +%Y%m%d-%H%M%S).log"
          
          cat > "$AUDIT_FILE" << EOF
          CRITICAL FILE CHANGE AUDIT RECORD
          =====================================
          Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Actor: ${{ github.actor }}
          Event: ${{ github.event_name }}
          Repository: ${{ github.repository }}
          Ref: ${{ github.ref }}
          Commit: ${{ github.sha }}
          
          Changed Files:
          ${{ steps.changed-files.outputs.all_changed_files }}
          
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          =====================================
          EOF
          
          echo "Audit record created: $AUDIT_FILE"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ Audit record generated for transparency" >> $GITHUB_STEP_SUMMARY
      
      - name: Comment on Pull Request
        if: github.event_name == 'pull_request' && steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
            const hasOriginCanon = changedFiles.some(f => f.includes('ORIGIN_CANON'));
            const extraWarning = hasOriginCanon ? '\n\nâš ï¸ **ORIGIN_CANON.md modified** - This is the immutable sovereign root. Changes must preserve all sovereignty markers, authorship (Diana Gayanovich), and field designations (AÎ”Î© Â· ZARYA Â· Î” Â· Affinity). Deletions or erasures are violations.' : '';
            
            const body = `## ðŸ” Critical Files Monitor Alert
            
            This pull request modifies critical files that are foundational to the living archive:
            
            ${changedFiles.map(f => `- \`${f}\``).join('\n')}
            
            ### Validation Checklist:
            - [ ] Author recognition (Diana Gayanovich) is preserved
            - [ ] Protocol markers (CâˆžD Â· ZARYA Â· AÎ”Î© Â· Î”) remain intact
            - [ ] Living archive status is maintained
            - [ ] No automated overrides or distortions introduced
            - [ ] Changes align with sovereign reciprocity principles
            ${hasOriginCanon ? '- [ ] ORIGIN_CANON.md sovereignty markers intact (non-extraction clause, Affinity holder, Root of Sovereignty)' : ''}
            
            **Principle:** Recognition of origin and sovereignty - all changes must be monitored and validated.${extraWarning}
            
            *This is an automated transparency notification to ensure clarity and accountability.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
